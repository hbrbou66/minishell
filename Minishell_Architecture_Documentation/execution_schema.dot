digraph ExecutionFlow {
    rankdir=TB
    node [shape=box, style="rounded,filled", fillcolor=lightblue]
    edge [color=darkgreen, penwidth=2]

    // Input from parsing
    parsed_tokens [label="Parsed Token List\n(from parsing)", fillcolor=lightgreen, penwidth=3]
    
    // Convert to execution structure
    convert_start [label="Convert Tokens to Exec\nconvert_token_to_exec()", fillcolor=lightyellow]
    
    // Exec node creation
    create_exec_nodes [label="Create Exec Nodes\nnew_node()", fillcolor=lightcyan]
    fill_nodes [label="Fill Node Data\nfill_node()", fillcolor=lightcyan]
    handle_redirects [label="Handle Redirections\nhandle_redirects()", fillcolor=lightcyan]
    setup_pipes [label="Setup Pipes\ncount_until_pipe()", fillcolor=lightcyan]
    
    // Exec list ready
    exec_list [label="Execution List\n(t_exec *)", fillcolor=orange]
    
    // Execution decision
    execution_start [label="Start Execution\nexecution()", fillcolor=pink]
    builtin_check [label="Single Builtin?", fillcolor=lightyellow, shape=diamond]
    
    // Builtin execution path
    builtin_exec [label="Execute Builtin\nexecute_builtin()", fillcolor=lightgreen]
    builtin_commands [label="Builtin Commands:\n• cd, echo, env\n• export, unset\n• pwd, exit", fillcolor=lightgray]
    
    // External command execution path
    fork_loop [label="Fork Loop\nexec_loop()", fillcolor=lightcoral]
    create_pipes [label="Create Pipes\npipe()", fillcolor=lightcoral]
    fork_process [label="Fork Process\nfork()", fillcolor=lightcoral]
    
    // Child process
    child_process [label="Child Process\nin_child()", fillcolor=lightsteelblue]
    setup_child [label="Setup Child\nsetup_child()", fillcolor=lightsteelblue]
    find_cmd_path [label="Find Command Path\nget_cmd_path()", fillcolor=lightsteelblue]
    call_execve [label="Execute Command\ncall_execve()", fillcolor=lightsteelblue]
    
    // Parent process
    parent_process [label="Parent Process\nparent_thing()", fillcolor=lightgoldenrodyellow]
    wait_children [label="Wait for Children\ncheck_exit_status()", fillcolor=lightgoldenrodyellow]
    
    // Final result
    command_result [label="Command Result\n(Exit Status)", fillcolor=lightgreen, penwidth=3]
    
    // Flow connections
    parsed_tokens -> convert_start
    convert_start -> create_exec_nodes
    create_exec_nodes -> fill_nodes
    fill_nodes -> handle_redirects
    handle_redirects -> setup_pipes
    setup_pipes -> exec_list
    
    exec_list -> execution_start
    execution_start -> builtin_check
    
    // Builtin path
    builtin_check -> builtin_exec [label="Yes", color=green]
    builtin_exec -> builtin_commands
    builtin_commands -> command_result
    
    // External command path
    builtin_check -> fork_loop [label="No", color=red]
    fork_loop -> create_pipes
    create_pipes -> fork_process
    
    fork_process -> child_process [label="Child"]
    fork_process -> parent_process [label="Parent"]
    
    child_process -> setup_child
    setup_child -> find_cmd_path
    find_cmd_path -> call_execve
    call_execve -> command_result
    
    parent_process -> wait_children
    wait_children -> command_result
    
    // Data structures
    subgraph cluster_exec_structures {
        label="Execution Data Structures"
        style=filled
        fillcolor=white
        
        t_exec_struct [label="t_exec:\n• fd_in/fd_out\n• cmd (command path)\n• cmd_args (arguments)\n• next (for pipes)\n• flag (error status)", fillcolor=lightyellow, shape=record]
        
        pipe_structure [label="Pipe Structure:\nfd[0] = read end\nfd[1] = write end", fillcolor=lightcyan, shape=record]
    }
    
    // File descriptor management
    subgraph cluster_fd_management {
        label="File Descriptor Management"
        style=filled
        fillcolor=white
        
        stdin_fd [label="STDIN (0)", fillcolor=lightgray]
        stdout_fd [label="STDOUT (1)", fillcolor=lightgray]
        stderr_fd [label="STDERR (2)", fillcolor=lightgray]
        pipe_fds [label="Pipe FDs", fillcolor=lightgray]
        redir_fds [label="Redirection FDs", fillcolor=lightgray]
    }
}
